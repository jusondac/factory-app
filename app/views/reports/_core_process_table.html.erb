<thead class="bg-gradient-to-r from-gray-50 to-slate-50">
  <tr>
    <th rowspan="3" class="px-1 py-1 text-center text-xs font-bold text-gray-700 uppercase border border-gray-300">Batch Code</th>
    <th rowspan="3" class="px-1 py-1 text-center text-xs font-bold text-gray-700 uppercase border border-gray-300">Product</th>
    <th colspan="<%= @production_machine_checkings.count %>" class="px-1 py-1 text-center text-xs font-bold text-gray-700 uppercase tracking-tight w-fit border border-gray-300">Machine Production</th>
    <th rowspan="3" class="px-1 py-1 text-center text-xs font-bold text-gray-700 uppercase tracking-tight w-fit border border-gray-300">Ingredients</th>
    <th rowspan="3" class="px-1 py-1 text-center text-xs font-bold text-gray-700 uppercase tracking-tight w-fit border border-gray-300">Progress</th>
  </tr>
  <tr>
    <% @production_machine_checkings_grouped.each do |group| %>
      <th colspan="<%= group[:checkings].count %>" class="px-1 py-1 text-center text-xs font-bold text-gray-700 uppercase tracking-tight w-fit border border-gray-300"><%= group[:machine].name %></th>
    <% end %>
  </tr>
  <tr>
    <% @production_machine_checkings_grouped.each do |group| %>
      <% group[:checkings].each do |checking| %>
        <th class="px-1 py-1 text-center text-xs font-bold text-gray-700 uppercase tracking-tight w-fit border border-gray-300 align-middle" style="writing-mode: vertical-rl; text-orientation: mixed; height: 80px; width: 40px; min-width: 40px; vertical-align: middle;"><%= checking.checking_name %></th>
      <% end %>
    <% end %>
  </tr>
</thead>
<tbody class="bg-white">
  <% @report_data.values.flatten.each do |unit_batch| %>
    <tr class="hover:bg-gray-50">
      <!-- Batch Code -->
      <td class="px-1 py-1 whitespace-nowrap w-fit border border-gray-300">
        <div class="text-xs font-medium text-gray-900"><%= unit_batch.batch_code %></div>
      </td>
      <!-- Product -->
      <td class="px-1 py-1 whitespace-nowrap w-fit border border-gray-300">
        <div class="text-xs text-gray-900"><%= unit_batch.product&.name || 'No product' %></div>
      </td>
      <!-- Machine Production Checking Answers -->
      <% @production_machine_checkings_grouped.each do |group| %>
        <% group[:checkings].each do |checking| %>
          <% 
            # Find the answer for this specific checking from production machines only
            answer = nil
            is_applicable_machine = false
            
            # Only check produce machine checks (production machines)
            if unit_batch.produce&.machine&.id == group[:machine].id
              is_applicable_machine = true
              machine_check = unit_batch.produce.produce_machine_checks.find { |mc| mc.machine_checking_id == checking.id }
              answer = machine_check&.answer
            end
          %>
          <td class="px-1 py-1 text-center text-xs w-fit border border-gray-300 <%= is_applicable_machine ? '' : 'bg-gray-100' %>">
            <% if is_applicable_machine %>
              <% if answer.present? %>
                <div class="text-gray-900 bg-blue-50 px-1 py-0.5 whitespace-nowrap rounded text-xs border border-blue-200">
                  <%= answer %>
                </div>
              <% else %>
                <div class="text-gray-400 text-xs">-</div>
              <% end %>
            <% else %>
              <div class="text-gray-500 text-xs">N/A</div>
            <% end %>
          </td>
        <% end %>
      <% end %>
      <!-- Ingredients Status -->
      <td class="px-1 py-1 w-fit border border-gray-300">
        <div class="text-xs text-gray-900">
          <% if unit_batch.prepare&.prepare_ingredients %>
            <% total = unit_batch.prepare.prepare_ingredients.count %>
            <% checked = unit_batch.prepare.prepare_ingredients.select { |pi| pi.checked }.count %>
            <% unchecked = unit_batch.prepare.prepare_ingredients.select { |pi| !pi.checked } %>
            <div class="space-y-1">
              <% if unchecked.any? %>
                <div class="text-red-600">
                  <% unchecked.each do |ingredient| %>
                    <span class="inline-block bg-red-100 text-red-800 text-xs px-1 py-0.5 rounded mr-1">
                      <%= ingredient.ingredient_name || 'Unknown' %>
                    </span>
                  <% end %>
                </div>
              <% else %>
                <span class="text-green-600 font-semibold text-xs">✓ All checked</span>
              <% end %>
            </div>
          <% else %>
            <span class="text-gray-500">N/A</span>
          <% end %>
        </div>
      </td>
      <!-- Progress Bar -->
      <td class="px-1 py-1 w-fit border border-gray-300">
        <div class="space-y-1">
          <div class="flex space-x-1">
            <% if unit_batch.prepare %>
              <% if unit_batch.prepare.prepare_ingredients.any? && unit_batch.prepare.prepare_ingredients.all?(&:checked) %>
                <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                  ✓ Prep
                </span>
              <% else %>
                <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                  ⏳ Prep
                </span>
              <% end %>
            <% end %>
            <% if unit_batch.produce %>
              <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                <% if unit_batch.produce.status == 'produced' %>✓<% else %>⏳<% end %> Prod
              </span>
            <% end %>
            <% if unit_batch.package %>
              <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                <% if unit_batch.package.status == 'package' %>✓<% else %>⏳<% end %> Pack
              </span>
            <% end %>
          </div>
        </div>
      </td>
    </tr>
  <% end %>
</tbody>
